name: Build APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Download Android SDK
        run: |
          sudo apt-get update
          sudo apt-get install -y android-sdk
          
      - name: Create Android Project
        run: |
          mkdir -p app/src/main/java/com/tapcounter/app
          mkdir -p app/src/main/res/layout
          mkdir -p app/src/main/res/values
          
          # MainActivity.kt
          cat > app/src/main/java/com/tapcounter/app/MainActivity.kt << 'EOF'
          package com.tapcounter.app
          import android.app.Activity
          import android.os.Bundle
          import android.widget.*
          
          class MainActivity : Activity() {
              private var count = 0
              override fun onCreate(b: Bundle?) {
                  super.onCreate(b)
                  val layout = LinearLayout(this)
                  layout.orientation = LinearLayout.VERTICAL
                  layout.gravity = Gravity.CENTER
                  
                  val text = TextView(this)
                  text.text = "0"
                  text.textSize = 100f
                  text.gravity = Gravity.CENTER
                  
                  val btn = Button(this)
                  btn.text = "TAP"
                  btn.textSize = 40f
                  btn.setOnClickListener {
                      count++
                      text.text = count.toString()
                  }
                  
                  val reset = Button(this)
                  reset.text = "RESET"
                  reset.setOnClickListener {
                      count = 0
                      text.text = "0"
                  }
                  
                  layout.addView(text)
                  layout.addView(btn)
                  layout.addView(reset)
                  setContentView(layout)
              }
          }
          EOF
          
          # AndroidManifest.xml
          cat > app/src/main/AndroidManifest.xml << 'EOF'
          <?xml version="1.0" encoding="utf-8"?>
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.tapcounter.app">
              <application android:label="Tap Counter">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF
          
          # build.gradle (project)
          echo "plugins { id 'com.android.application' version '7.4.2' apply false }" > build.gradle
          
          # build.gradle (app)
          mkdir -p app
          cat > app/build.gradle << 'EOF'
          plugins { id 'com.android.application' }
          android {
              namespace 'com.tapcounter.app'
              compileSdk 33
              defaultConfig {
                  applicationId "com.tapcounter.app"
                  minSdk 23
                  targetSdk 33
                  versionCode 1
                  versionName "1.0"
              }
          }
          EOF
          
          # settings.gradle
          echo 'include ":app"' > settings.gradle
          
      - name: Build APK
        run: |
          wget https://services.gradle.org/distributions/gradle-8.0-bin.zip -q
          unzip -q gradle-8.0-bin.zip
          ./gradle-8.0/bin/gradle wrapper
          ./gradlew assembleDebug
          
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: tap-counter-apk
          path: app/build/outputs/apk/debug/app-debug.apk
